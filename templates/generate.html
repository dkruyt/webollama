{% extends "base.html" %}

{% block title %}WebOllama - Generate{% endblock %}

{% block extra_css %}
<style>
    .result-container {
        min-height: 200px;
        max-height: 500px;
        overflow-y: auto;
        white-space: pre-wrap;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 15px;
        margin-top: 20px;
    }
    .advanced-options {
        border-top: 1px solid #dee2e6;
        padding-top: 15px;
        margin-top: 15px;
    }
    .stats-container {
        font-size: 0.85rem;
        margin-top: 15px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 10px;
    }
    .loader {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Save Preset Modal -->
<div class="modal fade" id="savePresetModal" tabindex="-1" aria-labelledby="savePresetModalLabel" aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog">
        <div class="modal-content" style="z-index: 1050;">
            <div class="modal-header">
                <h5 class="modal-title" id="savePresetModalLabel"><i class="fas fa-save me-2"></i>Save Parameter Preset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="preset-name" class="form-label">Preset Name</label>
                    <input type="text" class="form-control" id="preset-name" placeholder="My Custom Preset">
                </div>
                <div class="mb-3">
                    <label for="preset-description" class="form-label">Description (Optional)</label>
                    <textarea class="form-control" id="preset-description" rows="2" placeholder="What is this preset good for?"></textarea>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <small>This preset will be saved in your browser's local storage.</small>
                </div>
                
                <h6 class="mt-3">Current Parameters</h6>
                <table class="table table-sm">
                    <tr>
                        <td>Temperature</td>
                        <td><span id="modal-temperature-value">0.7</span></td>
                    </tr>
                    <tr>
                        <td>Top P</td>
                        <td><span id="modal-top-p-value">0.9</span></td>
                    </tr>
                    <tr>
                        <td>Top K</td>
                        <td><span id="modal-top-k-value">40</span></td>
                    </tr>
                    <tr>
                        <td>Max Tokens</td>
                        <td><span id="modal-max-tokens-value">Default</span></td>
                    </tr>
                    <tr>
                        <td>Context Size</td>
                        <td><span id="modal-context-size-value">Default</span></td>
                    </tr>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-preset-btn">Save Preset</button>
            </div>
        </div>
    </div>
</div>

<!-- Parameter Visualization Modal -->
<div class="modal fade" id="paramVisualizationModal" tabindex="-1" aria-labelledby="paramVisualizationModalLabel" aria-hidden="true" data-backdrop="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="z-index: 1050;">
            <div class="modal-header">
                <h5 class="modal-title" id="paramVisualizationModalLabel"><i class="fas fa-chart-bar me-2"></i>Parameter Effects Visualization</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>Temperature Effect</h6>
                        <div class="border p-3 rounded mb-2" style="height: 200px;">
                            <div class="temperature-viz d-flex flex-column justify-content-between h-100">
                                <div class="viz-row d-flex">
                                    <div class="me-2 text-end" style="width: 90px;">Temperature 0.2</div>
                                    <div class="progress flex-grow-1" style="height: 20px;">
                                        <div class="progress-bar bg-primary" role="progressbar" style="width: 90%;" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100"></div>
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 10%;" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                <div class="viz-row d-flex">
                                    <div class="me-2 text-end" style="width: 90px;">Temperature 0.7</div>
                                    <div class="progress flex-grow-1" style="height: 20px;">
                                        <div class="progress-bar bg-primary" role="progressbar" style="width: 60%;" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                                        <div class="progress-bar bg-secondary" role="progressbar" style="width: 15%;" aria-valuenow="15" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                                <div class="viz-row d-flex">
                                    <div class="me-2 text-end" style="width: 90px;">Temperature 1.5</div>
                                    <div class="progress flex-grow-1" style="height: 20px;">
                                        <div class="progress-bar bg-primary" role="progressbar" style="width: 30%;" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                                        <div class="progress-bar bg-secondary" role="progressbar" style="width: 15%;" aria-valuenow="15" aria-valuemin="0" aria-valuemax="100"></div>
                                        <div class="progress-bar bg-warning" role="progressbar" style="width: 30%;" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <small class="text-muted">Lower temperature focuses on most likely tokens. Higher temperature distributes probability more evenly.</small>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <h6>Top P & Top K Effect</h6>
                        <div class="border p-3 rounded mb-2" style="height: 200px;">
                            <div class="topk-viz d-flex flex-column justify-content-between h-100">
                                <div class="viz-row d-flex">
                                    <div class="me-2 text-end" style="width: 90px;">All Tokens</div>
                                    <div class="d-flex flex-grow-1">
                                        <div class="bg-primary p-1 me-1" style="width: 20%; height: 20px;"></div>
                                        <div class="bg-info p-1 me-1" style="width: 15%; height: 20px;"></div>
                                        <div class="bg-secondary p-1 me-1" style="width: 12%; height: 20px;"></div>
                                        <div class="bg-warning p-1 me-1" style="width: 8%; height: 20px;"></div>
                                        <div class="bg-danger p-1 me-1" style="width: 5%; height: 20px;"></div>
                                        <div class="bg-success p-1 me-1" style="width: 40%; height: 20px;"></div>
                                    </div>
                                </div>
                                <div class="viz-row d-flex">
                                    <div class="me-2 text-end" style="width: 90px;">Top P = 0.9</div>
                                    <div class="d-flex flex-grow-1">
                                        <div class="bg-primary p-1 me-1" style="width: 20%; height: 20px;"></div>
                                        <div class="bg-info p-1 me-1" style="width: 15%; height: 20px;"></div>
                                        <div class="bg-secondary p-1 me-1" style="width: 12%; height: 20px;"></div>
                                        <div class="bg-warning p-1 me-1" style="width: 8%; height: 20px;"></div>
                                        <div class="bg-danger p-1 me-1" style="width: 5%; height: 20px;"></div>
                                        <div class="bg-light p-1 me-1 border" style="width: 40%; height: 20px;"></div>
                                    </div>
                                </div>
                                <div class="viz-row d-flex">
                                    <div class="me-2 text-end" style="width: 90px;">Top K = 4</div>
                                    <div class="d-flex flex-grow-1">
                                        <div class="bg-primary p-1 me-1" style="width: 20%; height: 20px;"></div>
                                        <div class="bg-info p-1 me-1" style="width: 15%; height: 20px;"></div>
                                        <div class="bg-secondary p-1 me-1" style="width: 12%; height: 20px;"></div>
                                        <div class="bg-warning p-1 me-1" style="width: 8%; height: 20px;"></div>
                                        <div class="bg-light p-1 me-1 border" style="width: 45%; height: 20px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <small class="text-muted">Top P and Top K restrict token selection to the most likely tokens, limiting less probable choices.</small>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>Recommended Parameter Settings</h6>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Task Type</th>
                                <th>Temperature</th>
                                <th>Top P</th>
                                <th>Top K</th>
                                <th>Best For</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Creative Writing</strong></td>
                                <td>0.8 - 1.5</td>
                                <td>0.9 - 1.0</td>
                                <td>50 - 80</td>
                                <td>Stories, poetry, brainstorming ideas</td>
                            </tr>
                            <tr>
                                <td><strong>Balanced</strong></td>
                                <td>0.7</td>
                                <td>0.9</td>
                                <td>40</td>
                                <td>General use, balanced between creativity and precision</td>
                            </tr>
                            <tr>
                                <td><strong>Precise/Factual</strong></td>
                                <td>0.1 - 0.3</td>
                                <td>0.6 - 0.8</td>
                                <td>10 - 30</td>
                                <td>Factual responses, Q&A, summarization</td>
                            </tr>
                            <tr>
                                <td><strong>Code Generation</strong></td>
                                <td>0.2 - 0.5</td>
                                <td>0.8 - 0.9</td>
                                <td>30 - 50</td>
                                <td>Writing code, debugging, explanations</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row mb-3">
        <div class="col-12">
            <h1>Generate Text</h1>
        </div>
    </div>

    <div class="row">
        <div class="col-12 col-md-4 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Generation Options</h5>
                    
                    <div class="mb-3">
                        <label for="model-select" class="form-label">Model</label>
                        <select class="form-select" id="model-select">
                            <option value="" disabled selected>Select a model</option>
                            {% for model in models %}
                            <option value="{{ model.name }}" {% if request.args.get('model') == model.name %}selected{% endif %}>{{ model.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="system-prompt" class="form-label">System Prompt (optional)</label>
                        <textarea class="form-control" id="system-prompt" rows="3" placeholder="System instructions for the model..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="prompt-input" class="form-label">Prompt</label>
                        <textarea class="form-control" id="prompt-input" rows="5" placeholder="Enter your prompt here..." required></textarea>
                    </div>
                    
                    <div class="accordion" id="advancedOptionsAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingAdvanced">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAdvanced" aria-expanded="false" aria-controls="collapseAdvanced">
                                    Parameter Tuning
                                </button>
                            </h2>
                            <div id="collapseAdvanced" class="accordion-collapse collapse" aria-labelledby="headingAdvanced" data-bs-parent="#advancedOptionsAccordion">
                                <div class="accordion-body">
                                    <!-- Parameter Presets -->
                                    <div class="mb-3 border-bottom pb-3">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <label for="preset-select" class="form-label">Parameter Presets</label>
                                                <select class="form-select" id="preset-select">
                                                    <option value="" selected>Custom</option>
                                                    <option value="creative">Creative Writing</option>
                                                    <option value="balanced">Balanced</option>
                                                    <option value="precise">Precise/Factual</option>
                                                    <option value="coding">Code Generation</option>
                                                    <option disabled>──────────</option>
                                                    <option value="custom1" class="user-preset-option d-none">Custom 1</option>
                                                    <option value="custom2" class="user-preset-option d-none">Custom 2</option>
                                                    <option value="custom3" class="user-preset-option d-none">Custom 3</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4 d-flex align-items-end mb-2">
                                                <button type="button" class="btn btn-sm btn-outline-secondary w-100" data-bs-toggle="modal" data-bs-target="#savePresetModal">
                                                    <i class="fas fa-save me-1"></i> Save Preset
                                                </button>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-12 d-flex justify-content-between">
                                                <button type="button" class="btn btn-sm btn-link" data-bs-toggle="modal" data-bs-target="#paramVisualizationModal">
                                                    <i class="fas fa-chart-bar me-1"></i> Learn about parameters
                                                </button>
                                                <button type="button" class="btn btn-sm btn-link text-danger d-none" id="delete-preset-btn">
                                                    <i class="fas fa-trash me-1"></i> Delete preset
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Temperature with info tooltip -->
                                    <div class="mb-3">
                                        <label for="temperature" class="form-label d-flex justify-content-between align-items-center">
                                            <div>
                                                Temperature: <span id="temperature-value" class="badge bg-primary">0.7</span>
                                                <i class="fas fa-info-circle ms-1" data-bs-toggle="tooltip" title="Controls randomness. Higher values (e.g., 1.0) make output more random, lower values (e.g., 0.2) make it more deterministic."></i>
                                            </div>
                                        </label>
                                        <input type="range" class="form-range" min="0" max="2" step="0.1" value="0.7" id="temperature">
                                        <div class="d-flex justify-content-between text-muted small">
                                            <span>Precise</span>
                                            <span>Balanced</span>
                                            <span>Creative</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Top P with info tooltip -->
                                    <div class="mb-3">
                                        <label for="top-p" class="form-label d-flex justify-content-between align-items-center">
                                            <div>
                                                Top P: <span id="top-p-value" class="badge bg-primary">0.9</span>
                                                <i class="fas fa-info-circle ms-1" data-bs-toggle="tooltip" title="Nucleus sampling. Only consider tokens with top_p cumulative probability. Lower values reduce randomness."></i>
                                            </div>
                                        </label>
                                        <input type="range" class="form-range" min="0" max="1" step="0.05" value="0.9" id="top-p">
                                        <div class="d-flex justify-content-between text-muted small">
                                            <span>Focused</span>
                                            <span>Balanced</span>
                                            <span>Diverse</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Top K with info tooltip -->
                                    <div class="mb-3">
                                        <label for="top-k" class="form-label d-flex justify-content-between align-items-center">
                                            <div>
                                                Top K: <span id="top-k-value" class="badge bg-primary">40</span>
                                                <i class="fas fa-info-circle ms-1" data-bs-toggle="tooltip" title="Only sample from the top K most likely tokens. Lower values increase focus, higher values increase diversity."></i>
                                            </div>
                                        </label>
                                        <input type="range" class="form-range" min="1" max="100" step="1" value="40" id="top-k">
                                        <div class="d-flex justify-content-between text-muted small">
                                            <span>Focused</span>
                                            <span>Balanced</span>
                                            <span>Diverse</span>
                                        </div>
                                    </div>

                                    <!-- Min P with info tooltip -->
                                    <div class="mb-3">
                                        <label for="min-p" class="form-label d-flex justify-content-between align-items-center">
                                            <div>
                                                Min P: <span id="min-p-value" class="badge bg-primary">0.1</span>
                                                <i class="fas fa-info-circle ms-1" data-bs-toggle="tooltip" title="Sets a minimum probability for a token to be considered, relative to the probability of the most likely token."></i>
                                            </div>
                                        </label>
                                        <input type="range" class="form-range" min="0" max="1" step="0.05" value="0.1" id="min-p">
                                        <div class="d-flex justify-content-between text-muted small">
                                            <span>Focused</span>
                                            <span>Balanced</span>
                                            <span>Diverse</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Max Tokens with info tooltip -->
                                    <div class="mb-3">
                                        <label for="max-tokens" class="form-label d-flex align-items-center">
                                            <div>
                                                Max Tokens
                                                <i class="fas fa-info-circle ms-1" data-bs-toggle="tooltip" title="Maximum number of tokens to generate. Leave empty to use the model's default."></i>
                                            </div>
                                        </label>
                                        <input type="number" class="form-control" id="max-tokens" placeholder="Default: model's max context" min="1">
                                    </div>
                                    
                                    <!-- Context Size with info tooltip -->
                                    <div class="mb-3">
                                        <label for="context-size" class="form-label d-flex align-items-center">
                                            <div>
                                                Context Size
                                                <i class="fas fa-info-circle ms-1" data-bs-toggle="tooltip" title="Maximum number of tokens in the context window. Higher values allow for longer conversations but use more memory."></i>
                                            </div>
                                        </label>
                                        <input type="number" class="form-control" id="context-size" placeholder="Default: model defined" min="512" max="131072">
                                        <div class="form-text">Common values: 2048, 4096, 8192, 16384, 32768</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid mt-3">
                        <button class="btn btn-primary" id="generate-button" disabled>
                            <i class="fas fa-magic me-2"></i> Generate
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Generated Output</h5>
                    
                    <div id="result-loading" class="d-none">
                        <div class="d-flex align-items-center">
                            <div class="loader me-3"></div>
                            <span>Generating...</span>
                        </div>
                    </div>
                    
                    <div id="result-container" class="result-container d-none">
                        <!-- Generated text will appear here -->
                    </div>
                    
                    <div id="stats-container" class="stats-container d-none">
                        <!-- Generation stats will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Main UI elements
        const modelSelect = document.getElementById('model-select');
        const promptInput = document.getElementById('prompt-input');
        const systemPrompt = document.getElementById('system-prompt');
        const generateButton = document.getElementById('generate-button');
        const resultContainer = document.getElementById('result-container');
        const resultLoading = document.getElementById('result-loading');
        const statsContainer = document.getElementById('stats-container');
        
        // Parameter tuning elements
        const presetSelect = document.getElementById('preset-select');
        const deletePresetBtn = document.getElementById('delete-preset-btn');
        const savePresetBtn = document.getElementById('save-preset-btn');
        const presetNameInput = document.getElementById('preset-name');
        const presetDescriptionInput = document.getElementById('preset-description');
        
        // Parameter sliders and values
        const temperatureSlider = document.getElementById('temperature');
        const temperatureValue = document.getElementById('temperature-value');
        const topPSlider = document.getElementById('top-p');
        const topPValue = document.getElementById('top-p-value');
        const topKSlider = document.getElementById('top-k');
        const topKValue = document.getElementById('top-k-value');
        const minPSlider = document.getElementById('min-p');
        const minPValue = document.getElementById('min-p-value');
        const maxTokens = document.getElementById('max-tokens');
        const contextSize = document.getElementById('context-size');
        
        // Modal parameter values
        const modalTemperatureValue = document.getElementById('modal-temperature-value');
        const modalTopPValue = document.getElementById('modal-top-p-value');
        const modalTopKValue = document.getElementById('modal-top-k-value');
        const modalMinPValue = document.getElementById('modal-min-p-value');
        const modalMaxTokensValue = document.getElementById('modal-max-tokens-value');
        const modalContextSizeValue = document.getElementById('modal-context-size-value');
        
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.forEach(function (tooltipTriggerEl) {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Fix modal backdrop z-index and ensure modals are clickable
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('shown.bs.modal', function() {
                setTimeout(() => {
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => {
                        backdrop.style.zIndex = '1040';
                    });
                }, 50);
            });
        });
        
        // Explicitly initialize both modals for proper interaction
        const paramVisualizationModalEl = document.getElementById('paramVisualizationModal');
        const savePresetModalEl = document.getElementById('savePresetModal');
        
        // Initialize the parameter visualization modal
        if (paramVisualizationModalEl) {
            // Initialize with explicit options to fix clickability issues
            window.paramVisualizationModal = new bootstrap.Modal(paramVisualizationModalEl, {
                backdrop: false,
                keyboard: true
            });
            
            // Find the button that opens the param visualization modal and update its behavior
            const paramVisualizationBtn = document.querySelector('[data-bs-toggle="modal"][data-bs-target="#paramVisualizationModal"]');
            if (paramVisualizationBtn) {
                paramVisualizationBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.paramVisualizationModal.show();
                });
            }
        }
        
        // Initialize the save preset modal
        if (savePresetModalEl) {
            // Initialize with explicit options to fix clickability issues
            window.savePresetModal = new bootstrap.Modal(savePresetModalEl, {
                backdrop: false,
                keyboard: true
            });
            
            // Find the button that opens the save preset modal and update its behavior
            const savePresetBtn = document.querySelector('[data-bs-toggle="modal"][data-bs-target="#savePresetModal"]');
            if (savePresetBtn) {
                savePresetBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.savePresetModal.show();
                });
            }
        }
        
        let isGenerating = false;
        
        // Predefined preset configurations
        const presetConfigurations = {
            'creative': {
                name: 'Creative Writing',
                description: 'Optimized for creative tasks like storytelling, poetry, and idea generation.',
                temperature: 1.0,
                top_p: 0.95,
                top_k: 60,
                min_p: 0.1,
                max_tokens: '',
                context_size: '4096'
            },
            'balanced': {
                name: 'Balanced',
                description: 'General purpose settings balanced between creativity and precision.',
                temperature: 0.7,
                top_p: 0.9,
                top_k: 40,
                min_p: 0.1,
                max_tokens: '',
                context_size: '2048'
            },
            'precise': {
                name: 'Precise/Factual',
                description: 'Optimized for factual responses, Q&A, and information retrieval.',
                temperature: 0.2,
                top_p: 0.6,
                top_k: 20,
                min_p: 0.05,
                max_tokens: '',
                context_size: '2048'
            },
            'coding': {
                name: 'Code Generation',
                description: 'Optimized for writing code with high precision.',
                temperature: 0.3,
                top_p: 0.8,
                top_k: 35,
                min_p: 0.05,
                max_tokens: '',
                context_size: '8192'
            }
        };
        
        // Load user presets from localStorage
        loadUserPresets();
        
        // Event Listeners
        modelSelect.addEventListener('change', updateGenerateButton);
        promptInput.addEventListener('input', updateGenerateButton);
        
        // Parameter change events
        temperatureSlider.addEventListener('input', function() {
            temperatureValue.textContent = this.value;
            presetSelect.value = ''; // Reset to custom when user changes params
            updateDeleteButtonVisibility();
        });
        
        topPSlider.addEventListener('input', function() {
            topPValue.textContent = this.value;
            presetSelect.value = ''; // Reset to custom when user changes params
            updateDeleteButtonVisibility();
        });
        
        topKSlider.addEventListener('input', function() {
            topKValue.textContent = this.value;
            presetSelect.value = ''; // Reset to custom when user changes params
            updateDeleteButtonVisibility();
        });
        
        minPSlider.addEventListener('input', function() {
            minPValue.textContent = this.value;
            presetSelect.value = ''; // Reset to custom when user changes params
            updateDeleteButtonVisibility();
        });
        
        maxTokens.addEventListener('input', function() {
            presetSelect.value = ''; // Reset to custom when user changes params
            updateDeleteButtonVisibility();
        });
        
        contextSize.addEventListener('input', function() {
            presetSelect.value = ''; // Reset to custom when user changes params
            updateDeleteButtonVisibility();
        });
        
        // Save preset button
        savePresetBtn.addEventListener('click', function() {
            const presetName = presetNameInput.value.trim();
            if (!presetName) {
                alert('Please enter a name for your preset');
                return;
            }
            
            saveUserPreset(presetName);
            
            // Hide modal
            if (window.savePresetModal) {
                window.savePresetModal.hide();
            } else {
                // Fallback to the old method if our initialization didn't work
                const savePresetModal = bootstrap.Modal.getInstance(document.getElementById('savePresetModal'));
                if (savePresetModal) savePresetModal.hide();
            }
        });
        
        // Delete preset button
        deletePresetBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to delete this preset?')) {
                deleteUserPreset(presetSelect.value);
            }
        });
        
        // Preset selection change
        presetSelect.addEventListener('change', function() {
            applyPreset(this.value);
            updateDeleteButtonVisibility();
        });
        
        // Generate text
        generateButton.addEventListener('click', generateText);
        
        // Initialize if model is preselected from URL
        if (modelSelect.value) {
            updateGenerateButton();
        }
        
        // Update the save preset modal when shown
        document.getElementById('savePresetModal').addEventListener('show.bs.modal', function() {
            updateModalValues();
        });
        
        // Functions
        function updateGenerateButton() {
            generateButton.disabled = !modelSelect.value || !promptInput.value.trim() || isGenerating;
        }
        
        function updateDeleteButtonVisibility() {
            const selectedPreset = presetSelect.value;
            
            // Only show delete button for user presets (custom1, custom2, etc.)
            if (selectedPreset && selectedPreset.startsWith('custom')) {
                deletePresetBtn.classList.remove('d-none');
            } else {
                deletePresetBtn.classList.add('d-none');
            }
        }
        
        function loadUserPresets() {
            try {
                const userPresets = JSON.parse(localStorage.getItem('webollama_userPresets')) || {};
                
                // Clear existing custom options
                document.querySelectorAll('.user-preset-option').forEach(option => {
                    option.classList.add('d-none');
                    option.textContent = option.value;
                });
                
                // Add user presets to the select
                let index = 0;
                for (const key in userPresets) {
                    if (userPresets.hasOwnProperty(key) && index < 3) {
                        const option = document.querySelector(`.user-preset-option:nth-child(${index + 1})`);
                        if (option) {
                            option.textContent = userPresets[key].name;
                            option.classList.remove('d-none');
                            index++;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading user presets:', error);
            }
        }
        
        function saveUserPreset(presetName) {
            try {
                // Get current parameters
                const preset = {
                    name: presetName,
                    description: presetDescriptionInput.value.trim(),
                    temperature: parseFloat(temperatureSlider.value),
                    top_p: parseFloat(topPSlider.value),
                    top_k: parseInt(topKSlider.value),
                    min_p: parseFloat(minPSlider.value),
                    max_tokens: maxTokens.value,
                    context_size: contextSize.value
                };
                
                // Get existing presets
                const userPresets = JSON.parse(localStorage.getItem('webollama_userPresets')) || {};
                
                // Find a key to use (custom1, custom2, custom3)
                let presetKey = '';
                for (let i = 1; i <= 3; i++) {
                    if (!userPresets[`custom${i}`]) {
                        presetKey = `custom${i}`;
                        break;
                    }
                }
                
                // If all slots are used, use the first one
                if (!presetKey) {
                    presetKey = 'custom1';
                }
                
                // Save the preset
                userPresets[presetKey] = preset;
                localStorage.setItem('webollama_userPresets', JSON.stringify(userPresets));
                
                // Update the UI
                loadUserPresets();
                
                // Select the new preset
                presetSelect.value = presetKey;
                updateDeleteButtonVisibility();
                
            } catch (error) {
                console.error('Error saving user preset:', error);
                alert('Failed to save preset: ' + error.message);
            }
        }
        
        function deleteUserPreset(presetKey) {
            try {
                if (!presetKey || !presetKey.startsWith('custom')) {
                    return;
                }
                
                // Get existing presets
                const userPresets = JSON.parse(localStorage.getItem('webollama_userPresets')) || {};
                
                // Remove the preset
                delete userPresets[presetKey];
                localStorage.setItem('webollama_userPresets', JSON.stringify(userPresets));
                
                // Update the UI
                loadUserPresets();
                
                // Reset selection
                presetSelect.value = '';
                updateDeleteButtonVisibility();
                
            } catch (error) {
                console.error('Error deleting user preset:', error);
                alert('Failed to delete preset: ' + error.message);
            }
        }
        
        function applyPreset(presetKey) {
            if (!presetKey) {
                return; // Custom/no preset selected
            }
            
            let preset = null;
            
            // Check if it's a predefined preset
            if (presetConfigurations[presetKey]) {
                preset = presetConfigurations[presetKey];
            } else if (presetKey.startsWith('custom')) {
                // Check if it's a user preset
                try {
                    const userPresets = JSON.parse(localStorage.getItem('webollama_userPresets')) || {};
                    preset = userPresets[presetKey];
                } catch (error) {
                    console.error('Error loading user preset:', error);
                    return;
                }
            }
            
            if (!preset) {
                return;
            }
            
            // Apply preset values
            temperatureSlider.value = preset.temperature;
            temperatureValue.textContent = preset.temperature;
            
            topPSlider.value = preset.top_p;
            topPValue.textContent = preset.top_p;
            
            topKSlider.value = preset.top_k;
            topKValue.textContent = preset.top_k;
            
            minPSlider.value = preset.min_p;
            minPValue.textContent = preset.min_p;
            
            maxTokens.value = preset.max_tokens || '';
            contextSize.value = preset.context_size || '';
        }
        
        function updateModalValues() {
            // Update the values in the save preset modal
            modalTemperatureValue.textContent = temperatureSlider.value;
            modalTopPValue.textContent = topPSlider.value;
            modalTopKValue.textContent = topKSlider.value;
            modalMinPValue.textContent = minPSlider.value;
            modalMaxTokensValue.textContent = maxTokens.value || 'Default';
            modalContextSizeValue.textContent = contextSize.value || 'Default';
            
            // Clear input fields
            presetNameInput.value = '';
            presetDescriptionInput.value = '';
        }
        
        function generateText() {
            if (isGenerating) return;
            
            const model = modelSelect.value;
            const prompt = promptInput.value.trim();
            const system = systemPrompt.value.trim();
            
            if (!model || !prompt) return;
            
            // Prepare options
            const options = {};
            options.temperature = parseFloat(temperatureSlider.value);
            options.top_p = parseFloat(topPSlider.value);
            options.top_k = parseInt(topKSlider.value);
            options.min_p = parseFloat(minPSlider.value);
            
            if (maxTokens.value) {
                options.num_predict = parseInt(maxTokens.value);
            }
            
            if (contextSize.value) {
                options.num_ctx = parseInt(contextSize.value);
            }
            
            // Show loading indicator
            resultContainer.classList.add('d-none');
            statsContainer.classList.add('d-none');
            resultLoading.classList.remove('d-none');
            
            isGenerating = true;
            generateButton.disabled = true;
            
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            
            // Send to API
            fetch('/api/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    model: model,
                    prompt: prompt,
                    system: system,
                    options: options
                })
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading indicator
                resultLoading.classList.add('d-none');
                
                if (data.error) {
                    showError(data.error);
                } else {
                    // Display the result
                    resultContainer.innerHTML = marked.parse(data.response || '');
                    resultContainer.classList.remove('d-none');
                    
                    // Display stats
                    if (data.total_duration || data.eval_count) {
                        const stats = [];
                        
                        if (data.eval_count) {
                            stats.push(`Tokens generated: ${data.eval_count}`);
                        }
                        
                        if (data.prompt_eval_count) {
                            stats.push(`Prompt tokens: ${data.prompt_eval_count}`);
                        }
                        
                        if (data.eval_duration) {
                            const tokensPerSec = (data.eval_count / (data.eval_duration / 1e9)).toFixed(2);
                            stats.push(`Generation speed: ${tokensPerSec} tokens/sec`);
                        }
                        
                        if (data.total_duration) {
                            const seconds = (data.total_duration / 1e9).toFixed(2);
                            stats.push(`Total time: ${seconds} seconds`);
                        }
                        
                        statsContainer.innerHTML = stats.join(' • ');
                        statsContainer.classList.remove('d-none');
                    }
                }
            })
            .catch(error => {
                resultLoading.classList.add('d-none');
                if (error.message && error.message.includes("Unexpected token '<'")) {
                    showError('Server error: The server returned an HTML page instead of JSON. This may be due to CSRF token issues or the Ollama service not running.');
                } else {
                    showError('Network error: ' + error.message);
                }
            })
            .finally(() => {
                isGenerating = false;
                updateGenerateButton();
            });
        }
        
        function showError(message) {
            resultContainer.innerHTML = `<div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i> ${message}
            </div>`;
            resultContainer.classList.remove('d-none');
        }
    });
</script>
{% endblock %}
